# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Test WASM gltfpack

on:
  push: { branches: [master, "feature/*"] }
  pull_request: { branches: [master] }
  schedule: [{ cron: "0 0 * * 0" }] # Weekly check for new gltfpack versions
  workflow_dispatch:

env: { UV_PYTHON: "3.11" }

jobs:
  test-wasm:
    runs-on: ubuntu-latest
    permissions: { contents: read }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout three.js test models
        uses: actions/checkout@v6
        with:
          repository: mrdoob/three.js
          path: test-models/three.js
          sparse-checkout: examples/models/gltf
          sparse-checkout-cone-mode: false

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with: { activate-environment: true }

      - name: Install dependencies
        run: uv sync

      - name: Test WASM gltfpack on three.js models
        run: uv run python scripts/test_wasm_models.py

      - name: Report WASM version
        if: always()
        run: |
          echo "### WASM gltfpack Test Results" >> $GITHUB_STEP_SUMMARY
          uv run python -c "
          from notso_glb.wasm.download import get_cached_version
          print(f'- **gltfpack WASM version**: {get_cached_version() or \"unknown\"}')" >> $GITHUB_STEP_SUMMARY
