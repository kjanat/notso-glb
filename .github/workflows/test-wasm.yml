# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Test WASM gltfpack

on:
  push: { branches: [master, feature/*] }
  pull_request: { branches: [master] }
  schedule: [{ cron: "0 0 * * 0" }] # Weekly check for new gltfpack versions
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env: { UV_PYTHON: "3.11" }

jobs:
  test-wasm:
    runs-on: ubuntu-latest
    permissions: { contents: read }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout three.js test models
        uses: actions/checkout@v6
        with:
          repository: mrdoob/three.js
          path: test-models/three.js
          sparse-checkout: examples/models/gltf
          sparse-checkout-cone-mode: false

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with: { activate-environment: true }

      - name: Install dependencies
        run: uv sync

      - name: Download latest WASM from npm
        id: wasm
        uses: ./.github/actions/download-wasm

      - name: Test WASM gltfpack on three.js models
        id: test
        uses: ./.github/actions/test-wasm-models

      - name: Report results
        if: always()
        run: |
          {
            echo -e "### WASM gltfpack Test Results\n"
            echo "- **Bundled version**: ${{ steps.wasm.outputs.before }}"
            echo "- **Tested version**: ${{ steps.wasm.outputs.after }}"
            echo "- **Passed**: ${{ steps.test.outputs.passed }}"
            echo "- **Failed**: ${{ steps.test.outputs.failed }}"
            echo "- **Skipped**: ${{ steps.test.outputs.skipped }}"
          } >> "$GITHUB_STEP_SUMMARY"
