# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Claude Code
on:
  issue_comment: { types: [created, edited] }
  pull_request_review_comment: { types: [created, edited] }
  issues: { types: [opened, assigned, labeled] }
  pull_request_review: { types: [submitted, edited] }
  pull_request: { types: [opened, synchronize] }
  workflow_dispatch: { inputs: { prompt: { description: "Prompt for Claude", required: false, type: string } } }
jobs:
  claude:
    if: |
      github.event_name != 'pull_request' && (
        github.event_name == 'workflow_dispatch' ||
        (github.actor == github.repository_owner) && (
         (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
         (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
         (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
         (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))
        )))
    runs-on: ubuntu-latest
    permissions: { contents: write, pull-requests: write, issues: write, id-token: write, actions: read }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with: { fetch-depth: 0 }
      - uses: ./.github/actions/install-uv
      - uses: ./.github/actions/install-dprint
      - uses: taiki-e/install-action@just
      - name: install shfmt
        run: sudo apt-get install -y shfmt >/dev/null 2>&1
      - run: uv sync --all-groups --all-extras
      - name: "@claude"
        uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          use_commit_signing: true
          track_progress: true
          settings: ".github/config/claude.json"
          additional_permissions: "actions: read"
          prompt: ${{ github.event.inputs.prompt || '' }}
          label_trigger: claude
          assignee_trigger: claude
          branch_name_template: "{{prefix}}{{label}}-{{entityNumber}}-{{description}}"
          exclude_comments_by_actor: "*[bot]"
          allowed_bots: "coderabbitai[bot],dependabot[bot],renovate[bot]"
          claude_args: |
            --max-turns 25
            --model claude-opus-4-6

  claude-bot-review:
    name: "@claude v bots"
    if: |
      github.event_name == 'pull_request' && (
        github.actor == 'dependabot[bot]' ||
        github.actor == 'renovate[bot]'
      )
    runs-on: ubuntu-latest
    permissions: { contents: write, pull-requests: write, issues: write, id-token: write, actions: read }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with: { fetch-depth: 0 }
      - uses: ./.github/actions/install-uv
      - uses: ./.github/actions/install-dprint
      - uses: taiki-e/install-action@just
      - name: install shfmt
        run: sudo apt-get install -y shfmt >/dev/null 2>&1
      - run: uv sync --all-groups --all-extras
      - name: Review bot PR
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_commit_signing: true
          settings: ".github/config/claude.json"
          additional_permissions: "actions: read"
          prompt: |
            Review this dependency update PR #${{ github.event.pull_request.number }} by ${{ github.actor }}.
            Title: ${{ github.event.pull_request.title }}
            Base branch: ${{ github.base_ref }}
            Repo: ${{ github.repository }}

            <pr_description>
            ${{ github.event.pull_request.body }}
            </pr_description>

            1. Review the PR description above for changelogs and release notes
            2. Run `just test` to check for test failures
            3. Run `just lint` to verify lint passes
            4. Check for breaking changes, deprecations, or security advisories
            5. If issues found, fix them: update code for compatibility, fix tests, fix lint
            6. If everything passes (or after fixes), approve the PR with a summary
            7. Apply a label using `gh pr edit ${{ github.event.pull_request.number }} --add-label "claude: approved"`
               or `--add-label "claude: needs-attention"` if you couldn't fix it
          claude_args: |
            --max-turns 15
            --model claude-sonnet-4-5
